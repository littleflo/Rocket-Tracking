/*
   GROUND STATION: ULTIMATE EDITION
   - Startup:  5s Security Delay -> Cycling Waiting Screen.
   - Link:     Unlocks 4-Page "Fox Hunter" Interface on packet.
   - Pages:    1.Dash, 2.Coords, 3.Records, 4.Seeker(w/ K****).
   - Data:     Parses GPS + Baro.
*/

#include <Arduino.h>
#include <SPI.h>
#include <Wire.h>
#include <RadioLib.h>
#include <U8g2lib.h>
#include <Adafruit_LittleFS.h>
#include <InternalFileSystem.h>

using namespace Adafruit_LittleFS_Namespace;

// --- PINS (XIAO nRF52840) ---
const int PIN_LORA_SCK  = 30; 
const int PIN_LORA_MISO = 3;  
const int PIN_LORA_MOSI = 28; 
const int PIN_LORA_CS   = 46; 
const int PIN_LORA_DIO1 = 7;  
const int PIN_LORA_RST  = 39; 
const int PIN_LORA_BUSY = 42; 

const int PIN_OLED_SCL  = 5;  
const int PIN_OLED_SDA  = 6;  
const int PIN_BUZZER    = 32; 

// Battery Read
const int PIN_GS_BAT_READ = A0; 

// Joystick Pins
const int JOY_LEFT      = 11;  
const int JOY_RIGHT     = 35;  
const int JOY_UP        = 38;  
const int JOY_DOWN      = 12;  
const int JOY_BTN       = 37; 

// Display Driver
U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE, PIN_OLED_SCL, PIN_OLED_SDA);

SX1262 radio = new Module(PIN_LORA_CS, PIN_LORA_DIO1, PIN_LORA_RST, PIN_LORA_BUSY);

// --- VARIABLES ---
// Startup Logic
bool gotFirstPacket = false; 
bool showSplash = true;      
unsigned long lastScreenCycle = 0; 

// Flight Data
double rktLat = 0.0, rktLon = 0.0;
String gpsAlt = "0";
String baroAlt = "0";
String rktSpd = "0";
float rktVolts = 0.0;

// Records
float maxAlt = 0.0;
float maxSpd = 0.0;

// System
int currentScreen = 0; // 0=Dash, 1=Coords, 2=Records, 3=Seeker
unsigned long lastDebounce = 0;
bool hasAlerted = false;
float startAlt = -1000.0; 
bool isAscending = false;

// Signal Graph
int rssiHistory[128]; 
int rssiIndex = 0;
float lastRSSI = -120.0;

// --- HELPERS ---
float readGSBattery() {
  int val = analogRead(PIN_GS_BAT_READ);
  if (val < 100) return 0.0; 
  return (val / 1023.0) * 3.3 * 2.0; 
}

int getPercent(float volts) {
  return constrain(map((long)(volts * 100), 360, 420, 0, 100), 0, 100);
}

String getChargeTime(float volts) {
  if (volts >= 4.15) return "Full";
  float hours = (4.20 - volts) * 10.0; 
  return "~" + String(hours, 1) + "h";
}

// --- SCREENS ---
void drawRestrictedScreen() {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_helvB08_tr); 
  u8g2.drawStr(15, 10, "** RESTRICTED **");
  u8g2.setFont(u8g2_font_5x8_tr);
  u8g2.drawStr(0, 25, "Authorized Users:");
  u8g2.setFont(u8g2_font_helvB08_tr); 
  // Insert your callsign, then delete this comment u8g2.drawStr(0, 38, "Your_Callsign_Here or Other HAMs");
  u8g2.setFont(u8g2_font_helvB10_tr); 
  u8g2.drawStr(0, 58, "47CFR 90.403(f)");
  u8g2.sendBuffer();
}

void drawWaitingScreen() {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_helvB10_tr);
  u8g2.drawStr(0, 30, "Waiting for Link...");
  u8g2.setFont(u8g2_font_5x8_tr);
  u8g2.drawStr(0, 45, "Listening on 915MHz");
  // Insert your callsign, then delete this comment u8g2.drawStr(0, 55, "Searching for: Your_Callsign_Here");
  u8g2.sendBuffer();
}

// 1. DASHBOARD
void drawDashboard() {
  u8g2.setFont(u8g2_font_5x8_tr); 
  u8g2.setCursor(0, 8);
  u8g2.print("S:"); u8g2.print(lastRSSI, 0);
  u8g2.print(" R:"); u8g2.print(rktVolts, 1); u8g2.print("V ");
  u8g2.print(getPercent(rktVolts)); u8g2.print("%");
  
  u8g2.setCursor(0, 18); u8g2.print("R-Chg: "); u8g2.print(getChargeTime(rktVolts));

  // Big Data
  u8g2.setFont(u8g2_font_ncenB14_tr); 
  u8g2.setCursor(0, 42);
  u8g2.print(gpsAlt); u8g2.setFont(u8g2_font_ncenB10_tr); u8g2.print("ft");

  u8g2.setCursor(70, 42);
  u8g2.setFont(u8g2_font_ncenB14_tr); 
  u8g2.print(rktSpd); u8g2.setFont(u8g2_font_ncenB10_tr); u8g2.print("mh");

  // Status
  u8g2.setFont(u8g2_font_5x8_tr); 
  u8g2.setCursor(0, 58);
  if(hasAlerted) u8g2.print("DESCENDING");
  else if(isAscending) u8g2.print("ASCENDING");
  else u8g2.print("READY");
  
  u8g2.setCursor(105, 58); u8g2.print("1/4");
}

// 2. COORDS
void drawCoords() {
  u8g2.setFont(u8g2_font_helvB08_tr);
  u8g2.setCursor(0, 10); u8g2.print("ROCKET COORDS");

  u8g2.setFont(u8g2_font_6x12_tr); // Monospace
  u8g2.setCursor(0, 30); u8g2.print("Lat:"); 
  u8g2.setCursor(30, 30); u8g2.print(rktLat, 5);
  
  u8g2.setCursor(0, 45); u8g2.print("Lon:"); 
  u8g2.setCursor(30, 45); u8g2.print(rktLon, 5);

  u8g2.setFont(u8g2_font_5x8_tr);
  u8g2.setCursor(105, 58); u8g2.print("2/4");
}

// 3. RECORDS
void drawRecords() {
  u8g2.setFont(u8g2_font_helvB08_tr);
  u8g2.drawStr(30, 10, "FLIGHT PEAKS");

  u8g2.setFont(u8g2_font_6x12_tr);
  u8g2.setCursor(0, 25); u8g2.print("Max Alt: "); u8g2.print(maxAlt, 0); u8g2.print(" ft");
  u8g2.setCursor(0, 38); u8g2.print("Max Spd: "); u8g2.print(maxSpd, 0); u8g2.print(" mph");
  u8g2.setCursor(0, 51); u8g2.print("Baro Now:"); u8g2.print(baroAlt); 

  u8g2.setFont(u8g2_font_5x8_tr);
  u8g2.setCursor(105, 58); u8g2.print("3/4");
}

// 4. SEEKER (UPDATED)
void drawSeeker() {
  u8g2.setFont(u8g2_font_helvB12_tr);
  // Insert your callsign, then delete this comment u8g2.setCursor(0, 12); u8g2.print("Your_Callsign_Here"); 
  
  // Current RSSI Big
  u8g2.setFont(u8g2_font_helvB10_tr);
  u8g2.setCursor(65, 12); u8g2.print(lastRSSI, 0); u8g2.setFont(u8g2_font_5x8_tr); u8g2.print("dBm");

  // Draw Graph
  u8g2.drawFrame(0, 20, 128, 44);
  for (int i=0; i<128; i++) {
     int val = rssiHistory[(rssiIndex + i) % 128];
     int h = map(val, -140, -40, 63, 21);
     h = constrain(h, 21, 63);
     u8g2.drawPixel(i, h);
  }

  u8g2.setCursor(105, 18); u8g2.print("4/4");
}

void setup() {
  Serial.begin(115200);
  pinMode(PIN_BUZZER, OUTPUT); digitalWrite(PIN_BUZZER, LOW);
  
  pinMode(JOY_LEFT, INPUT_PULLUP);
  pinMode(JOY_RIGHT, INPUT_PULLUP);
  pinMode(JOY_UP, INPUT_PULLUP);
  pinMode(JOY_DOWN, INPUT_PULLUP);
  pinMode(JOY_BTN, INPUT_PULLUP);
  pinMode(PIN_GS_BAT_READ, INPUT);
  analogReadResolution(10); 
  
  // Init History
  for(int i=0; i<128; i++) rssiHistory[i] = -120;

  // 1. Filesystem
  if (!InternalFS.begin()) { InternalFS.format(); InternalFS.begin(); }
  File f = InternalFS.open("/flight.csv", FILE_O_WRITE);
  if(f) { 
    f.seek(f.size()); 
    f.println(); f.println("--- RESTART ---"); 
    f.close(); 
  }

  // 2. Init Screen
  Wire.setPins(PIN_OLED_SDA, PIN_OLED_SCL);
  u8g2.setI2CAddress(0x3D * 2);             
  u8g2.begin();

  // --- STARTUP SEQUENCE ---
  drawRestrictedScreen();
  delay(5000); // 5 Seconds Mandatory
  // -----------------------

  // 3. Init Radio
  SPI.setPins(PIN_LORA_MISO, PIN_LORA_SCK, PIN_LORA_MOSI);
  SPI.begin();
  radio.begin(915.0);
  radio.setSpreadingFactor(10); radio.setBandwidth(250.0); radio.setCodingRate(7); radio.setOutputPower(22);      
}

void loop() {
  // --- SERIAL DUMP ---
  if(Serial.available()) {
      String cmd = Serial.readStringUntil('\n');
      if(cmd.indexOf("dump") >= 0) {
         Serial.println("\n--- DUMP ---");
         File f = InternalFS.open("/flight.csv", FILE_O_READ);
         if(f) { while(f.available()) Serial.write(f.read()); f.close(); }
         Serial.println("\n--- END ---");
      }
  }

  // --- RADIO CHECK ---
  String str;
  int state = radio.receive(str);

  // Insert your callsign, then delete this comment if (state == RADIOLIB_ERR_NONE && str.indexOf("Your_Callsign_Here") >= 0) {
      gotFirstPacket = true; // UNLOCK SCREENS
      
      Serial.println(str);
      lastRSSI = radio.getRSSI();
      
      // Update Graph
      rssiHistory[rssiIndex] = (int)lastRSSI;
      rssiIndex = (rssiIndex + 1) % 128;

      File f = InternalFS.open("/flight.csv", FILE_O_WRITE);
      if(f) { f.seek(f.size()); f.println(String(millis()) + "," + str); f.close(); }

      // Parsing: K****, Lat, Lon, GPSAlt, Spd, Volts, Pop, Baro
      int c1 = str.indexOf(',');
      int c2 = str.indexOf(',', c1+1);
      int c3 = str.indexOf(',', c2+1);
      int c4 = str.indexOf(',', c3+1);
      int c5 = str.indexOf(',', c4+1); 
      int c6 = str.indexOf(',', c5+1); 
      int c7 = str.indexOf(',', c6+1); 
      
      String latS = str.substring(c1+1, c2);
      String lonS = str.substring(c2+1, c3);
      rktLat = atof(latS.c_str());
      rktLon = atof(lonS.c_str());
      
      gpsAlt = str.substring(c3+1, c4);
      rktSpd = str.substring(c4+1, c5);
      rktVolts = str.substring(c5+1, c6).toFloat();
      String popStr = str.substring(c6+1, c7);
      baroAlt = str.substring(c7+1); 

      bool dropDetected = (popStr.toInt() == 1);

      // Stats
      float cAlt = gpsAlt.toFloat();
      float cSpd = rktSpd.toFloat();
      if(cAlt > maxAlt) maxAlt = cAlt;
      if(cSpd > maxSpd) maxSpd = cSpd;

      // Alarm
      if (dropDetected && !hasAlerted) {
          u8g2.clearBuffer();
          u8g2.setFont(u8g2_font_helvB10_tr); u8g2.drawStr(0, 25, "Chute Deployment!");
          u8g2.setFont(u8g2_font_ncenB08_tr); u8g2.drawStr(0, 45, "Continuity Break!");
          u8g2.sendBuffer();
          unsigned long s = millis();
          while(millis() - s < 3000) { tone(PIN_BUZZER, 4000); delay(200); noTone(PIN_BUZZER); delay(100); }
          hasAlerted = true;
      }
      if (!dropDetected) hasAlerted = false;

      // Ascent Logic
      if (startAlt == -1000.0 && cAlt > 0) startAlt = cAlt; 
      if (startAlt != -1000.0 && cAlt > (startAlt + 50)) isAscending = true;
  }
  
  // --- DISPLAY LOGIC ---
  if (!gotFirstPacket) {
      // WAITING MODE (Cycling)
      if (millis() - lastScreenCycle > 1500) {
          lastScreenCycle = millis();
          showSplash = !showSplash;
          if (showSplash) drawRestrictedScreen();
          else drawWaitingScreen();
      }
  } else {
      // DATA MODE (Unlocked)
      
      // Nav Inputs
      if (millis() - lastDebounce > 250) {
        if (digitalRead(JOY_RIGHT) == LOW) { 
           currentScreen++; if (currentScreen > 3) currentScreen = 0;
           u8g2.clearBuffer(); lastDebounce = millis();
        }
        if (digitalRead(JOY_LEFT) == LOW) { 
           currentScreen--; if (currentScreen < 0) currentScreen = 3;
           u8g2.clearBuffer(); lastDebounce = millis();
        }
      }

      // Draw active screen
      static unsigned long lastDraw = 0;
      if (millis() - lastDraw > 100) {
         u8g2.clearBuffer();
         if(currentScreen == 0) drawDashboard();
         else if(currentScreen == 1) drawCoords();
         else if(currentScreen == 2) drawRecords();
         else if(currentScreen == 3) drawSeeker();
         u8g2.sendBuffer();
         lastDraw = millis();
      }
  }
}
